# Query Engine Redesign

There have been some issues that have plagued PostGraph's design for the past 4 years ago when it was called AgensGraph-Extension. Since the Postgres hook system can't be used until after the parser is run, we have had to hide the query from Postgres. One of the biggest complaints I always heard was how everyone hated that the query gets wrapped around with the `SELECT * FROM cypher('', $$ ... $$) AS (a gtype);` Also, DDL commands have to be run in functions, which causes a number of usability problems and things like indices cannot be created concurrently.&#x20;

The original idea I had was to create a piece of middleware that sat between the client and Postgres, which takes a cypher or hybrid query and transforms it into something that Postgres can process without syntax errors... which always sounded like a painful experience to get working right.&#x20;

So, if I create a process that listens on another port, PostGraph can process the query itself. This is lets me not need to work around Postgres' parser and transform logic. First, I will just copy the Postgres Frontend/Backend Protocol and model Postgres' query processing engine exactly the same, with a different parser and transform logic. That way I can implement the `USE GRAPH;` command, support real DDL commands, solve performance issues on DDL commands, simplify the integration of SQL and Cypher (with a lot of copy/paste from Postgres source code for the sql side), and support all Postgres drivers, connection poolers, etc.&#x20;

Then I will support the Bolt connection protocol so Neo4J applications can be used with PostGraph. Still need to figure out how to handle multi-label cypher queries, especially since I am redesigning the label system farther away from theirs.

This also leads into some more backend designs to plan after, the primary concern for other designs right now is that Cypher needs sessions between the client and server to know which graph it is supposed to be querying against. That might get fixed by forcing people using these other backend designs to use the `FROM` clause which exists in several proposed specs for multi graph queries, but not implemented anywhere, or maybe a set of processes that handle each requests to each graph and clients register which graph they are using, and when a client changes graph a the process assigned to handle that request will alter its registration information. Not sure about that, this idea is in it's infancy.
